name: Build GameServer

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_CONFIGURATION: Debug
  BUILD_PLATFORM: Win32

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Display environment
      run: |
        Write-Host "=== Build Environment ===" -ForegroundColor Cyan
        Write-Host "Runner OS: $env:RUNNER_OS" -ForegroundColor Gray
        Write-Host "Workspace: $env:GITHUB_WORKSPACE" -ForegroundColor Gray
        Write-Host "Build Configuration: $env:BUILD_CONFIGURATION" -ForegroundColor Gray
        Write-Host "Build Platform: $env:BUILD_PLATFORM" -ForegroundColor Gray
      shell: pwsh
      
    - name: Setup PropertySheets
      run: |
        Write-Host "=== Setting up PropertySheets ===" -ForegroundColor Cyan
        
        # Project file expects PropertySheets at ..\..\PropertySheets\ relative to project
        # In GitHub Actions, we're at D:\a\wd02\wd02, so we need PropertySheets at D:\a\wd02\PropertySheets
        $targetPropsDir = "..\PropertySheets"
        
        if (-not (Test-Path $targetPropsDir)) {
            New-Item -ItemType Directory -Path $targetPropsDir -Force | Out-Null
            Write-Host "Created PropertySheets directory at: $targetPropsDir" -ForegroundColor Green
        }
        
        # Copy PropertySheets from repository if they exist
        if (Test-Path "PropertySheets") {
            Write-Host "Copying PropertySheets from repository..." -ForegroundColor Cyan
            Copy-Item -Path "PropertySheets\*" -Destination $targetPropsDir -Recurse -Force
            Write-Host "Copied PropertySheets to: $targetPropsDir" -ForegroundColor Green
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Check dependencies
      id: check-deps
      run: |
        Write-Host "=== Dependency Check ===" -ForegroundColor Cyan
        $deps = @{}
        $missingDeps = @()
        
        # Check for CrossRoads
        $crossRoadsPaths = @(
          "..\Cryptic\CrossRoads",
          "..\CrossRoads",
          "Cryptic\CrossRoads",
          "CrossRoads"
        )
        foreach ($path in $crossRoadsPaths) {
          if (Test-Path $path) {
            $deps["CrossRoads"] = $path
            Write-Host "OK: CrossRoads found at: $path" -ForegroundColor Green
            break
          }
        }
        if (-not $deps["CrossRoads"]) {
          Write-Host "ERROR: CrossRoads not found" -ForegroundColor Red
          $missingDeps += "CrossRoads"
        }
        
        # Check for Core
        $corePaths = @(
          "..\Cryptic\Core",
          "..\core",
          "Cryptic\Core",
          "core"
        )
        foreach ($path in $corePaths) {
          if (Test-Path $path) {
            $deps["Core"] = $path
            Write-Host "OK: Core found at: $path" -ForegroundColor Green
            break
          }
        }
        if (-not $deps["Core"]) {
          Write-Host "ERROR: Core not found" -ForegroundColor Red
          $missingDeps += "Core"
        }
        
        # Output for next steps
        $hasRequired = ($deps["CrossRoads"] -and $deps["Core"])
        Write-Host "`n=== Dependency Summary ===" -ForegroundColor Cyan
        Write-Host "Required dependencies available: $hasRequired" -ForegroundColor $(if ($hasRequired) { "Green" } else { "Red" })
        
        if ($missingDeps.Count -gt 0) {
          Write-Host "`nMissing dependencies:" -ForegroundColor Red
          $missingDeps | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
        }
        
        echo "has_required=$hasRequired" >> $env:GITHUB_OUTPUT
        echo "missing_deps=$($missingDeps -join ',')" >> $env:GITHUB_OUTPUT
      shell: pwsh
      continue-on-error: true
      
    - name: Validate project file
      run: |
        Write-Host "=== Validating Project File ===" -ForegroundColor Cyan
        $projectPath = "NNOGameServer.vcxproj"
        
        if (-not (Test-Path $projectPath)) {
          Write-Host "ERROR: Project file not found: $projectPath" -ForegroundColor Red
          exit 1
        }
        
        Write-Host "OK: Project file found: $projectPath" -ForegroundColor Green
      shell: pwsh
      
    - name: Build GameServer
      id: build
      run: |
        Write-Host "=== Building GameServer ===" -ForegroundColor Cyan
        $projectPath = "NNOGameServer.vcxproj"
        $buildLog = "build.log"
        
        Write-Host "Project: $projectPath" -ForegroundColor Gray
        Write-Host "Configuration: $env:BUILD_CONFIGURATION" -ForegroundColor Gray
        Write-Host "Platform: $env:BUILD_PLATFORM" -ForegroundColor Gray
        Write-Host ""
        
        # Check dependencies before building
        if ("${{ steps.check-deps.outputs.has_required }}" -ne "true") {
          Write-Host "WARNING: Required dependencies are missing!" -ForegroundColor Yellow
          Write-Host "Build will likely fail due to missing dependencies:" -ForegroundColor Yellow
          Write-Host "${{ steps.check-deps.outputs.missing_deps }}" -ForegroundColor Red
          Write-Host ""
          Write-Host "Attempting build anyway to capture error details..." -ForegroundColor Cyan
        }
        
        # Build with detailed logging and capture output paths
        $buildOutput = ""
        $outputPathLog = "output-paths.log"
        try {
          # Build and capture output
          msbuild $projectPath `
            /p:Configuration=$env:BUILD_CONFIGURATION `
            /p:Platform=$env:BUILD_PLATFORM `
            /t:Build `
            /v:detailed `
            /nologo `
            /fl `
            /flp:logfile=$buildLog;verbosity=detailed `
            /p:OutDir=Debug\ `
            /p:TargetName=GameServer `
            2>&1 | Tee-Object -Variable buildOutput | Out-File -FilePath $outputPathLog -Encoding UTF8
          
          $buildExitCode = $LASTEXITCODE
          
          # Extract output paths from build log
          Write-Host "`n=== Extracting Output Paths from Build Log ===" -ForegroundColor Cyan
          if (Test-Path $buildLog) {
            $outputPaths = Select-String -Path $buildLog -Pattern "Output.*GameServer\.exe|Linking.*GameServer\.exe|Target.*GameServer\.exe|OutDir|OutputDirectory" -CaseSensitive:$false
            if ($outputPaths) {
              Write-Host "Found output path references:" -ForegroundColor Green
              $outputPaths | Select-Object -First 10 | ForEach-Object {
                Write-Host "  $($_.Line.Trim())" -ForegroundColor Gray
              }
            }
          }
        } catch {
          Write-Host "Build command failed: $_" -ForegroundColor Red
          $buildExitCode = 1
        }
        
        # Analyze build output
        Write-Host "`n=== Build Analysis ===" -ForegroundColor Cyan
        
        if (Test-Path $buildLog) {
          $errorCount = 0
          
          # Count errors - check for various error patterns
          $errorPatterns = @(
            "error\s+(CS|C\d{4}|LNK|MSB)",
            "error MSB",
            "error C",
            "error LNK",
            "fatal error",
            "cannot open",
            "unresolved external",
            "not found"
          )
          
          $allErrors = @()
          foreach ($pattern in $errorPatterns) {
            $matches = Select-String -Path $buildLog -Pattern $pattern -CaseSensitive:$false
            if ($matches) {
              $allErrors += $matches
            }
          }
          
          if ($allErrors) {
            $errorCount = ($allErrors | Select-Object -Unique Line).Count
            Write-Host "ERROR: Found $errorCount unique error(s)" -ForegroundColor Red
            Write-Host "`nFirst 20 errors:" -ForegroundColor Yellow
            $allErrors | Select-Object -First 20 -Unique Line | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Red
            }
          } else {
            Write-Host "OK: No compilation errors found in log" -ForegroundColor Green
          }
          
          # Check if build actually compiled anything
          Write-Host "`n=== Build Activity Analysis ===" -ForegroundColor Cyan
          
          # Check for compilation
          $compiling = Select-String -Path $buildLog -Pattern "Compiling|cl\.exe|\.c.*->.*\.obj" -CaseSensitive:$false
          if ($compiling) {
            Write-Host "OK: Found compilation activity ($($compiling.Count) instances)" -ForegroundColor Green
            $compiling | Select-Object -First 5 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Gray
            }
          } else {
            Write-Host "WARNING: No compilation activity found!" -ForegroundColor Yellow
          }
          
          # Check for linking
          $linking = Select-String -Path $buildLog -Pattern "Linking|link\.exe|\.exe.*created|\.dll.*created" -CaseSensitive:$false
          if ($linking) {
            Write-Host "OK: Found linking activity ($($linking.Count) instances)" -ForegroundColor Green
            $linking | Select-Object -First 5 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Gray
            }
          } else {
            Write-Host "WARNING: No linking activity found!" -ForegroundColor Yellow
            Write-Host "  This means no executable was created." -ForegroundColor Yellow
          }
          
          # Check for target completion
          $targets = Select-String -Path $buildLog -Pattern "Done building target|Done executing task|Build succeeded|Build FAILED" -CaseSensitive:$false
          if ($targets) {
            Write-Host "`nBuild target status:" -ForegroundColor Cyan
            $targets | Select-Object -Last 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Gray
            }
          }
          
          # Check for project references that failed
          $refErrors = Select-String -Path $buildLog -Pattern "Project.*not found|unable to find|cannot open project" -CaseSensitive:$false
          if ($refErrors) {
            Write-Host "`nWARNING: Project reference errors found:" -ForegroundColor Yellow
            $refErrors | Select-Object -First 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Yellow
            }
          }
          
          # Check for include file errors
          $includeErrors = Select-String -Path $buildLog -Pattern "cannot open include file|fatal error.*\.h" -CaseSensitive:$false
          if ($includeErrors) {
            Write-Host "`nERROR: Include file errors found:" -ForegroundColor Red
            $includeErrors | Select-Object -First 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Red
            }
          }
          
          # Summary
          if (-not $compiling -and -not $linking) {
            Write-Host "`nCRITICAL: No compilation or linking activity detected!" -ForegroundColor Red
            Write-Host "  The build likely failed before any source files were compiled." -ForegroundColor Red
            Write-Host "  Common causes:" -ForegroundColor Yellow
            Write-Host "    1. Missing dependencies (CrossRoads, Core, libs)" -ForegroundColor Gray
            Write-Host "    2. Missing project references" -ForegroundColor Gray
            Write-Host "    3. Pre-build events failed" -ForegroundColor Gray
            Write-Host "    4. PropertySheets errors" -ForegroundColor Gray
          } elseif ($compiling -and -not $linking) {
            Write-Host "`nWARNING: Files were compiled but not linked!" -ForegroundColor Yellow
            Write-Host "  This suggests linking step failed or was skipped." -ForegroundColor Yellow
          } elseif ($compiling -and $linking) {
            Write-Host "`nOK: Build shows both compilation and linking activity" -ForegroundColor Green
          }
        } else {
          Write-Host "WARNING: Build log file not found" -ForegroundColor Yellow
          Write-Host "  Build may have failed before logging started." -ForegroundColor Yellow
        }
        
        # Also check build output for key indicators
        if ($buildOutput) {
          Write-Host "`n=== Build Output Summary ===" -ForegroundColor Cyan
          $outputLines = $buildOutput -split "`n"
          $successIndicators = $outputLines | Where-Object { $_ -match "succeeded|Build succeeded|0 Error" }
          $failureIndicators = $outputLines | Where-Object { $_ -match "failed|Build FAILED|Error\(s\)" }
          
          if ($successIndicators) {
            Write-Host "Build output shows success indicators:" -ForegroundColor Green
            $successIndicators | Select-Object -First 3 | ForEach-Object {
              Write-Host "  $_" -ForegroundColor Gray
            }
          }
          
          if ($failureIndicators) {
            Write-Host "Build output shows failure indicators:" -ForegroundColor Red
            $failureIndicators | Select-Object -First 3 | ForEach-Object {
              Write-Host "  $_" -ForegroundColor Red
            }
          }
        }
        
        # Check for output files - search more thoroughly
        Write-Host "`n=== Checking for Build Outputs ===" -ForegroundColor Cyan
        
        # First, try to find GameServer.exe specifically (the target name)
        $targetExe = "GameServer.exe"
        Write-Host "Looking for target executable: $targetExe" -ForegroundColor Cyan
        
        # Common output locations for Visual Studio projects
        $searchPaths = @(
          "Debug\$targetExe",
          "Debug\Win32\$targetExe",
          "Win32\Debug\$targetExe",
          "Release\$targetExe",
          "Release\Win32\$targetExe",
          "Win32\Release\$targetExe",
          "bin\Debug\$targetExe",
          "bin\Release\$targetExe",
          "$targetExe",
          ".\$targetExe"
        )
        
        # Also search directories
        $searchDirs = @(
          "Debug",
          "Release",
          "bin",
          "bin\Debug",
          "bin\Release",
          "x64\Debug",
          "x64\Release",
          "Win32\Debug",
          "Win32\Release",
          ".\Debug",
          ".\Release"
        )
        
        Write-Host "Searching for output files in:" -ForegroundColor Gray
        $searchPaths | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }
        $searchDirs | ForEach-Object { Write-Host "  - $_\" -ForegroundColor Gray }
        Write-Host ""
        
        $foundOutputs = $false
        $allFoundFiles = @()
        
        # First, check specific paths for the target exe
        foreach ($searchPath in $searchPaths) {
          if (Test-Path $searchPath) {
            $item = Get-Item $searchPath
            Write-Host "OK: Found target executable at: $searchPath" -ForegroundColor Green
            Write-Host "  Size: $([math]::Round($item.Length/1KB,2)) KB" -ForegroundColor Gray
            $allFoundFiles += $item
            $foundOutputs = $true
            break
          }
        }
        
        # If not found, search directories
        if (-not $foundOutputs) {
          foreach ($searchDir in $searchDirs) {
            if (Test-Path $searchDir) {
              $item = Get-Item $searchDir
              if ($item -is [System.IO.DirectoryInfo]) {
                $files = Get-ChildItem $searchDir -Recurse -File -ErrorAction SilentlyContinue
                if ($files) {
                  Write-Host "OK: Found output directory: $searchDir ($($files.Count) files)" -ForegroundColor Green
                  $exeFiles = $files | Where-Object { $_.Extension -eq '.exe' -or $_.Extension -eq '.dll' -or $_.Extension -eq '.lib' }
                  if ($exeFiles) {
                    Write-Host "  Executable/Library files:" -ForegroundColor Cyan
                    $exeFiles | Select-Object -First 10 Name, @{Name="Size(KB)";Expression={[math]::Round($_.Length/1KB,2)}}, FullName | Format-Table -AutoSize
                    $allFoundFiles += $exeFiles
                    $foundOutputs = $true
                  }
                }
              }
            }
          }
        }
        
        # Also search for .exe files recursively in current directory
        if (-not $foundOutputs) {
          Write-Host "Searching for .exe files recursively in current directory..." -ForegroundColor Yellow
          $exeFiles = Get-ChildItem "." -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "*GameServer*" -or $_.Name -like "*Game*" }
          if ($exeFiles) {
            Write-Host "OK: Found .exe files:" -ForegroundColor Green
            $exeFiles | Select-Object FullName, @{Name="Size(KB)";Expression={[math]::Round($_.Length/1KB,2)}} | Format-Table -AutoSize
            $foundOutputs = $true
            $allFoundFiles += $exeFiles
          }
        }
        
        # Show all directories in current location for debugging
        if (-not $foundOutputs) {
          Write-Host "`nCurrent directory structure:" -ForegroundColor Yellow
          Get-ChildItem "." -Directory | Select-Object Name | Format-Table -AutoSize
          Write-Host "All files in current directory:" -ForegroundColor Yellow
          Get-ChildItem "." -File | Select-Object Name, Length | Format-Table -AutoSize
        }
        
        if (-not $foundOutputs) {
          Write-Host "ERROR: No build output files found!" -ForegroundColor Red
          Write-Host "This indicates the build did not produce any executables." -ForegroundColor Yellow
        } else {
          Write-Host "`nOK: Total output files found: $($allFoundFiles.Count)" -ForegroundColor Green
        }
        
        echo "exit_code=$buildExitCode" >> $env:GITHUB_OUTPUT
        echo "found_outputs=$foundOutputs" >> $env:GITHUB_OUTPUT
        echo "error_count=$errorCount" >> $env:GITHUB_OUTPUT
        
        # Exit with error if build failed
        if ($buildExitCode -ne 0) {
          Write-Host "`nERROR: Build failed with exit code: $buildExitCode" -ForegroundColor Red
          exit $buildExitCode
        }
        
        if (-not $foundOutputs) {
          Write-Host "`nERROR: Build completed but no output files found!" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Upload build artifacts
      if: steps.build.outputs.found_outputs == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-outputs
        path: |
          GameServer.exe
          Debug/
          Debug/GameServer.exe
          Debug/Win32/
          Win32/Debug/
          Win32/Debug/GameServer.exe
          Release/
          Release/GameServer.exe
          bin/
          bin/Debug/
          bin/Release/
        if-no-files-found: warn
      
    - name: Show why no artifacts
      if: steps.build.outputs.found_outputs != 'true'
      run: |
        Write-Host "=== Why No Build Artifacts ===" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "Build completed but no output files were found." -ForegroundColor Red
        Write-Host ""
        Write-Host "This usually means:" -ForegroundColor Cyan
        Write-Host "  1. Missing dependencies (CrossRoads, Core, libs)" -ForegroundColor Gray
        Write-Host "  2. Build failed before compilation started" -ForegroundColor Gray
        Write-Host "  3. No source files were compiled" -ForegroundColor Gray
        Write-Host ""
        Write-Host "Check the build.log artifact for detailed error information." -ForegroundColor Yellow
        Write-Host "Download build-log to see what went wrong." -ForegroundColor Yellow
      shell: pwsh
        
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        if-no-files-found: ignore
        retention-days: 30
        
    - name: Build summary
      if: always()
      run: |
        Write-Host "`n=== Build Summary ===" -ForegroundColor Cyan
        
        $exitCode = "${{ steps.build.outputs.exit_code }}"
        $foundOutputs = "${{ steps.build.outputs.found_outputs }}"
        $errorCount = "${{ steps.build.outputs.error_count }}"
        
        Write-Host "Exit Code: $exitCode" -ForegroundColor $(if ($exitCode -eq "0") { "Green" } else { "Red" })
        Write-Host "Outputs Found: $foundOutputs" -ForegroundColor $(if ($foundOutputs -eq "true") { "Green" } else { "Red" })
        Write-Host "Error Count: $errorCount" -ForegroundColor $(if ($errorCount -eq "0") { "Green" } else { "Red" })
        
        if ($exitCode -eq "0" -and $foundOutputs -eq "true") {
          Write-Host "`nOK: Build completed successfully!" -ForegroundColor Green
          Write-Host "Check artifacts for build outputs." -ForegroundColor Gray
        } else {
          Write-Host "`nERROR: Build failed or no outputs generated" -ForegroundColor Red
          Write-Host "`nCommon reasons:" -ForegroundColor Yellow
          Write-Host "  1. Missing dependencies (CrossRoads, Core, libs)" -ForegroundColor Gray
          Write-Host "  2. Missing PropertySheets configuration files" -ForegroundColor Gray
          Write-Host "  3. Missing structparser.exe pre-build tool" -ForegroundColor Gray
          Write-Host "  4. Missing required header files or libraries" -ForegroundColor Gray
          Write-Host "  5. Compilation errors in source code" -ForegroundColor Gray
          Write-Host "`nCheck build.log artifact for detailed error information." -ForegroundColor Cyan
        }
      shell: pwsh

