name: Build GameServer

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_CONFIGURATION: Debug
  BUILD_PLATFORM: Win32

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Display environment
      run: |
        Write-Host "=== Build Environment ===" -ForegroundColor Cyan
        Write-Host "Runner OS: $env:RUNNER_OS" -ForegroundColor Gray
        Write-Host "Workspace: $env:GITHUB_WORKSPACE" -ForegroundColor Gray
        Write-Host "Build Configuration: $env:BUILD_CONFIGURATION" -ForegroundColor Gray
        Write-Host "Build Platform: $env:BUILD_PLATFORM" -ForegroundColor Gray
      shell: pwsh
      
    - name: Setup PropertySheets
      run: |
        Write-Host "=== Setting up PropertySheets ===" -ForegroundColor Cyan
        
        # Project file expects PropertySheets at ..\..\PropertySheets\ relative to project
        # In GitHub Actions, we're at D:\a\wd02\wd02, so we need PropertySheets at D:\a\wd02\PropertySheets
        $targetPropsDir = "..\PropertySheets"
        
        if (-not (Test-Path $targetPropsDir)) {
            New-Item -ItemType Directory -Path $targetPropsDir -Force | Out-Null
            Write-Host "Created PropertySheets directory at: $targetPropsDir" -ForegroundColor Green
        }
        
        # Copy PropertySheets from repository if they exist
        if (Test-Path "PropertySheets") {
            Write-Host "Copying PropertySheets from repository..." -ForegroundColor Cyan
            Copy-Item -Path "PropertySheets\*" -Destination $targetPropsDir -Recurse -Force
            Write-Host "Copied PropertySheets to: $targetPropsDir" -ForegroundColor Green
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Check Git Submodules
      run: |
        Write-Host "=== Checking Git Submodules ===" -ForegroundColor Cyan
        
        # Check if .gitmodules exists
        if (Test-Path ".gitmodules") {
          Write-Host "OK: .gitmodules file found" -ForegroundColor Green
          Write-Host "`nSubmodule configuration:" -ForegroundColor Cyan
          Get-Content .gitmodules | Write-Host
          
          # Check submodule status
          Write-Host "`nChecking submodule status..." -ForegroundColor Yellow
          $submoduleStatus = git submodule status
          if ($submoduleStatus) {
            Write-Host "Submodule status:" -ForegroundColor Cyan
            $submoduleStatus | Write-Host
            
            # Check if any are not initialized (lines starting with -)
            $uninitialized = $submoduleStatus | Where-Object { $_ -match '^-\s' }
            if ($uninitialized) {
              Write-Host "`nWARNING: Some submodules are not initialized!" -ForegroundColor Yellow
              $uninitialized | ForEach-Object {
                Write-Host "  $_" -ForegroundColor Yellow
              }
              Write-Host "`nInitializing submodules..." -ForegroundColor Yellow
              git submodule update --init --recursive
              if ($LASTEXITCODE -eq 0) {
                Write-Host "OK: Submodules initialized successfully" -ForegroundColor Green
              } else {
                Write-Host "ERROR: Submodule initialization failed" -ForegroundColor Red
                Write-Host "This may require authentication or the submodule URLs may be incorrect." -ForegroundColor Yellow
              }
            } else {
              Write-Host "OK: All submodules are initialized" -ForegroundColor Green
            }
          } else {
            Write-Host "INFO: No submodules found in status" -ForegroundColor Gray
          }
        } else {
          Write-Host "INFO: No .gitmodules file found" -ForegroundColor Gray
          Write-Host "Dependencies may need to be added manually. See ADD_DEPENDENCIES.md" -ForegroundColor Yellow
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Check dependencies
      id: check-deps
      run: |
        Write-Host "=== Comprehensive Dependency Check ===" -ForegroundColor Cyan
        $deps = @{}
        $missingDeps = @()
        $warnings = @()
        
        # Check for CrossRoads
        Write-Host "`nChecking CrossRoads..." -ForegroundColor Yellow
        $crossRoadsPaths = @(
          "..\Cryptic\CrossRoads",
          "..\CrossRoads",
          "Cryptic\CrossRoads",
          "CrossRoads"
        )
        $foundCrossRoads = $false
        foreach ($path in $crossRoadsPaths) {
          if (Test-Path $path) {
            $deps["CrossRoads"] = $path
            Write-Host "OK: CrossRoads found at: $path" -ForegroundColor Green
            # Check for key files
            $keyFiles = @(
              "$path\GameServerLib\GameServerLib.vcxproj",
              "$path\Common\pvp_common.c"
            )
            foreach ($file in $keyFiles) {
              if (Test-Path $file) {
                Write-Host "  OK: Key file exists: $file" -ForegroundColor Gray
              } else {
                Write-Host "  WARNING: Key file missing: $file" -ForegroundColor Yellow
                $warnings += "CrossRoads key file missing: $file"
              }
            }
            $foundCrossRoads = $true
            break
          }
        }
        if (-not $foundCrossRoads) {
          Write-Host "ERROR: CrossRoads not found in any expected location" -ForegroundColor Red
          $missingDeps += "CrossRoads"
        }
        
        # Check for Core
        Write-Host "`nChecking Core..." -ForegroundColor Yellow
        $corePaths = @(
          "..\Cryptic\Core",
          "..\core",
          "Cryptic\Core",
          "core"
        )
        $foundCore = $false
        foreach ($path in $corePaths) {
          if (Test-Path $path) {
            $deps["Core"] = $path
            Write-Host "OK: Core found at: $path" -ForegroundColor Green
            $foundCore = $true
            break
          }
        }
        if (-not $foundCore) {
          Write-Host "ERROR: Core not found in any expected location" -ForegroundColor Red
          $missingDeps += "Core"
        }
        
        # Check for libs
        Write-Host "`nChecking libs..." -ForegroundColor Yellow
        $libsPaths = @(
          "..\libs",
          "libs"
        )
        $foundLibs = $false
        foreach ($path in $libsPaths) {
          if (Test-Path $path) {
            $deps["libs"] = $path
            Write-Host "OK: libs found at: $path" -ForegroundColor Green
            # Check for required lib projects
            $requiredLibs = @("AILib", "ContentLib", "HttpLib", "ServerLib", "WorldLib", "UtilitiesLib")
            foreach ($lib in $requiredLibs) {
              $libPath = "$path\$lib\$lib.vcxproj"
              if (Test-Path $libPath) {
                Write-Host "  OK: $lib project found" -ForegroundColor Gray
              } else {
                Write-Host "  WARNING: $lib project not found" -ForegroundColor Yellow
                $warnings += "$lib project missing"
              }
            }
            $foundLibs = $true
            break
          }
        }
        if (-not $foundLibs) {
          Write-Host "WARNING: libs directory not found" -ForegroundColor Yellow
          $warnings += "libs directory missing"
        }
        
        # Check for utilities/structparser
        Write-Host "`nChecking utilities/structparser..." -ForegroundColor Yellow
        $structparserPaths = @(
          "..\utilities\bin\structparser.exe",
          "utilities\bin\structparser.exe"
        )
        $foundStructparser = $false
        foreach ($path in $structparserPaths) {
          if (Test-Path $path) {
            Write-Host "OK: structparser.exe found at: $path" -ForegroundColor Green
            $foundStructparser = $true
            break
          }
        }
        if (-not $foundStructparser) {
          Write-Host "WARNING: structparser.exe not found (pre-build may fail)" -ForegroundColor Yellow
          $warnings += "structparser.exe missing"
        }
        
        # Check project references
        Write-Host "`nChecking project references..." -ForegroundColor Yellow
        if (Test-Path "NNOGameServer.vcxproj") {
          $projContent = Get-Content "NNOGameServer.vcxproj" -Raw
          $refMatches = [regex]::Matches($projContent, '<ProjectReference Include="([^"]+)"')
          Write-Host "Found $($refMatches.Count) project references" -ForegroundColor Gray
          foreach ($match in $refMatches) {
            $refPath = $match.Groups[1].Value
            # Normalize path
            $refPath = $refPath -replace '\\', '\'
            if (Test-Path $refPath) {
              Write-Host "  OK: $refPath" -ForegroundColor Gray
            } else {
              Write-Host "  ERROR: $refPath (not found)" -ForegroundColor Red
              $warnings += "Project reference missing: $refPath"
            }
          }
        }
        
        # Output for next steps
        $hasRequired = ($deps["CrossRoads"] -and $deps["Core"])
        Write-Host "`n=== Dependency Summary ===" -ForegroundColor Cyan
        Write-Host "Required dependencies available: $hasRequired" -ForegroundColor $(if ($hasRequired) { "Green" } else { "Red" })
        
        if ($missingDeps.Count -gt 0) {
          Write-Host "`nCRITICAL: Missing required dependencies:" -ForegroundColor Red
          $missingDeps | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
          Write-Host "`nSee ADD_DEPENDENCIES.md for instructions on adding dependencies." -ForegroundColor Yellow
        }
        
        if ($warnings.Count -gt 0) {
          Write-Host "`nWARNINGS:" -ForegroundColor Yellow
          $warnings | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
        }
        
        if (-not $hasRequired) {
          Write-Host "`n❌ BUILD WILL FAIL: Required dependencies are missing!" -ForegroundColor Red
          Write-Host "Please add dependencies before building. See ADD_DEPENDENCIES.md" -ForegroundColor Yellow
        }
        
        echo "has_required=$hasRequired" >> $env:GITHUB_OUTPUT
        echo "missing_deps=$($missingDeps -join ',')" >> $env:GITHUB_OUTPUT
        echo "warnings=$($warnings.Count)" >> $env:GITHUB_OUTPUT
      shell: pwsh
      continue-on-error: true
      
    - name: Validate project file and structure
      run: |
        Write-Host "=== Validating Project File and Structure ===" -ForegroundColor Cyan
        
        # Check project file
        $projectPath = "NNOGameServer.vcxproj"
        if (-not (Test-Path $projectPath)) {
          Write-Host "ERROR: Project file not found: $projectPath" -ForegroundColor Red
          exit 1
        }
        Write-Host "OK: Project file found: $projectPath" -ForegroundColor Green
        
        # Check for source files
        Write-Host "`n=== Checking Source Files ===" -ForegroundColor Cyan
        $projContent = Get-Content $projectPath -Raw
        $sourceFiles = [regex]::Matches($projContent, '<ClCompile\s+Include="([^"]+)"')
        if ($sourceFiles.Count -gt 0) {
          Write-Host "OK: Found $($sourceFiles.Count) source files in project" -ForegroundColor Green
          Write-Host "First 5 source files:" -ForegroundColor Gray
          $sourceFiles | Select-Object -First 5 | ForEach-Object {
            $file = $_.Groups[1].Value
            Write-Host "  - $file" -ForegroundColor Gray
            # Check if file exists
            if (Test-Path $file) {
              Write-Host "    OK: File exists" -ForegroundColor DarkGreen
            } else {
              Write-Host "    WARNING: File not found" -ForegroundColor Yellow
            }
          }
        } else {
          Write-Host "ERROR: No source files found in project!" -ForegroundColor Red
          Write-Host "This will cause build to skip compilation." -ForegroundColor Red
        }
        
        # Check key files
        Write-Host "`n=== Checking Key Files ===" -ForegroundColor Cyan
        $keyFiles = @(
          "NNOLogging.c",
          "Common\NNOCommon.c",
          "Common\NNOCommon.h"
        )
        $missingFiles = @()
        foreach ($file in $keyFiles) {
          if (Test-Path $file) {
            Write-Host "OK: $file exists" -ForegroundColor Green
          } else {
            Write-Host "ERROR: $file MISSING" -ForegroundColor Red
            $missingFiles += $file
          }
        }
        
        if ($missingFiles.Count -gt 0) {
          Write-Host "`nWARNING: Some key files are missing!" -ForegroundColor Yellow
          Write-Host "Build may fail or skip compilation." -ForegroundColor Yellow
        }
        
        # Check PropertySheets
        Write-Host "`n=== Checking PropertySheets ===" -ForegroundColor Cyan
        $propsFiles = @(
          "PropertySheets\GeneralSettings.props",
          "PropertySheets\CrypticApplication.props",
          "PropertySheets\LinkerOptimizations.props"
        )
        foreach ($props in $propsFiles) {
          if (Test-Path $props) {
            Write-Host "OK: $props exists" -ForegroundColor Green
          } else {
            Write-Host "WARNING: $props missing" -ForegroundColor Yellow
          }
        }
        
        # Check project references
        Write-Host "`n=== Checking Project References ===" -ForegroundColor Cyan
        $refMatches = [regex]::Matches($projContent, '<ProjectReference\s+Include="([^"]+)"')
        Write-Host "Found $($refMatches.Count) project references" -ForegroundColor Gray
        $missingRefs = @()
        foreach ($match in $refMatches) {
          $refPath = $match.Groups[1].Value
          # Normalize path separators
          $refPath = $refPath -replace '/', '\'
          Write-Host "  Checking: $refPath" -ForegroundColor Gray
          if (Test-Path $refPath) {
            Write-Host "    OK: Project reference exists" -ForegroundColor DarkGreen
          } else {
            Write-Host "    ERROR: Project reference NOT FOUND" -ForegroundColor Red
            $missingRefs += $refPath
          }
        }
        
        if ($missingRefs.Count -gt 0) {
          Write-Host "`nCRITICAL: Missing project references:" -ForegroundColor Red
          $missingRefs | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
          Write-Host "`nThis will cause MSBuild to skip compilation!" -ForegroundColor Red
          Write-Host "Build will 'succeed' but produce no output." -ForegroundColor Red
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Build GameServer
      id: build
      run: |
        Write-Host "=== Building GameServer ===" -ForegroundColor Cyan
        $solutionPath = "NNOGameServer.sln"
        $projectPath = "NNOGameServer.vcxproj"
        $buildLog = "build.log"
        
        Write-Host "Solution: $solutionPath" -ForegroundColor Gray
        Write-Host "Project: $projectPath" -ForegroundColor Gray
        Write-Host "Configuration: $env:BUILD_CONFIGURATION" -ForegroundColor Gray
        Write-Host "Platform: $env:BUILD_PLATFORM" -ForegroundColor Gray
        Write-Host ""
        
        # Check if solution file exists, use it if available
        if (Test-Path $solutionPath) {
          Write-Host "OK: Using solution file: $solutionPath" -ForegroundColor Green
          $buildTarget = $solutionPath
        } elseif (Test-Path $projectPath) {
          Write-Host "WARNING: Solution file not found, using project file: $projectPath" -ForegroundColor Yellow
          $buildTarget = $projectPath
        } else {
          Write-Host "ERROR: Neither solution nor project file found!" -ForegroundColor Red
          exit 1
        }
        
        # Check dependencies before building
        if ("${{ steps.check-deps.outputs.has_required }}" -ne "true") {
          Write-Host "WARNING: Required dependencies are missing!" -ForegroundColor Yellow
          Write-Host "Build will likely fail due to missing dependencies:" -ForegroundColor Yellow
          Write-Host "${{ steps.check-deps.outputs.missing_deps }}" -ForegroundColor Red
          Write-Host ""
          Write-Host "Attempting build anyway to capture error details..." -ForegroundColor Cyan
        }
        
        # Build with detailed logging and capture output paths
        $buildOutput = ""
        $outputPathLog = "output-paths.log"
        try {
          # Build and capture output
          # Note: For solution builds, MSBuild uses default output paths
          # Output typically goes to: $(SolutionDir)$(Platform)\$(Configuration)\
          msbuild $buildTarget `
            /p:Configuration=$env:BUILD_CONFIGURATION `
            /p:Platform=$env:BUILD_PLATFORM `
            /t:Build `
            /v:detailed `
            /nologo `
            /fl `
            /flp:logfile=$buildLog;verbosity=detailed `
            /p:TargetName=GameServer `
            2>&1 | Tee-Object -Variable buildOutput | Out-File -FilePath $outputPathLog -Encoding UTF8
          
          $buildExitCode = $LASTEXITCODE
          
          # Extract output paths from build log
          Write-Host "`n=== Extracting Output Paths from Build Log ===" -ForegroundColor Cyan
          if (Test-Path $buildLog) {
            # Look for actual output file paths
            $outputPaths = Select-String -Path $buildLog -Pattern "Output.*GameServer\.exe|Linking.*GameServer\.exe|Target.*GameServer\.exe|OutDir|OutputDirectory|\.exe.*succeeded|Creating.*\.exe" -CaseSensitive:$false
            if ($outputPaths) {
              Write-Host "Found output path references:" -ForegroundColor Green
              $outputPaths | Select-Object -First 15 | ForEach-Object {
                Write-Host "  $($_.Line.Trim())" -ForegroundColor Gray
              }
            }
            
            # Extract actual file paths from log
            $exePaths = Select-String -Path $buildLog -Pattern "([A-Z]:[^:]*GameServer\.exe|\.\\[^:]*GameServer\.exe)" -CaseSensitive:$false
            if ($exePaths) {
              Write-Host "`nFound executable paths in log:" -ForegroundColor Green
              $exePaths | Select-Object -First 5 | ForEach-Object {
                $path = $_.Matches[0].Value
                Write-Host "  $path" -ForegroundColor Cyan
                if (Test-Path $path) {
                  Write-Host "    -> File exists!" -ForegroundColor Green
                }
              }
            }
          }
        } catch {
          Write-Host "Build command failed: $_" -ForegroundColor Red
          $buildExitCode = 1
        }
        
        # Analyze build output
        Write-Host "`n=== Build Analysis ===" -ForegroundColor Cyan
        
        if (Test-Path $buildLog) {
          Write-Host "Build log file size: $((Get-Item $buildLog).Length) bytes" -ForegroundColor Gray
          
          # Extract key error summary from log
          Write-Host "`n=== Key Error Summary ===" -ForegroundColor Cyan
          
          # MSB3202: Project file not found
          $msb3202 = Select-String -Path $buildLog -Pattern "MSB3202.*not found" -CaseSensitive:$false
          if ($msb3202) {
            Write-Host "CRITICAL: Project file not found errors:" -ForegroundColor Red
            $msb3202 | Select-Object -First 10 | ForEach-Object {
              $line = $_.Line -replace '.*MSB3202:\s*', ''
              Write-Host "  $line" -ForegroundColor Red
            }
          }
          
          # MSB4019: Imported project not found
          $msb4019 = Select-String -Path $buildLog -Pattern "MSB4019.*not found" -CaseSensitive:$false
          if ($msb4019) {
            Write-Host "CRITICAL: Imported project not found errors:" -ForegroundColor Red
            $msb4019 | Select-Object -First 10 | ForEach-Object {
              $line = $_.Line -replace '.*MSB4019:\s*', ''
              Write-Host "  $line" -ForegroundColor Red
            }
          }
          
          # C1083: Cannot open include file
          $c1083 = Select-String -Path $buildLog -Pattern "C1083.*Cannot open include" -CaseSensitive:$false
          if ($c1083) {
            Write-Host "ERROR: Cannot open include file:" -ForegroundColor Red
            $c1083 | Select-Object -First 10 | ForEach-Object {
              $line = $_.Line -replace '.*C1083:\s*', ''
              Write-Host "  $line" -ForegroundColor Red
            }
          }
          
          # LNK2019: Unresolved external symbol
          $lnk2019 = Select-String -Path $buildLog -Pattern "LNK2019.*unresolved external" -CaseSensitive:$false
          if ($lnk2019) {
            Write-Host "ERROR: Unresolved external symbols:" -ForegroundColor Red
            $lnk2019 | Select-Object -First 10 | ForEach-Object {
              $line = $_.Line -replace '.*LNK2019:\s*', ''
              Write-Host "  $line" -ForegroundColor Red
            }
          }
          
          # Check which projects were built successfully
          Write-Host "`n=== Project Build Status ===" -ForegroundColor Cyan
          $projectSuccess = Select-String -Path $buildLog -Pattern "Project.*succeeded|Project.*failed|Building.*\.vcxproj" -CaseSensitive:$false
          if ($projectSuccess) {
            Write-Host "Project build results:" -ForegroundColor Yellow
            $projectSuccess | Select-Object -Last 20 | ForEach-Object {
              if ($_.Line -match "succeeded|SUCCEEDED") {
                Write-Host "  ✓ $($_.Line.Trim())" -ForegroundColor Green
              } elseif ($_.Line -match "failed|FAILED|error") {
                Write-Host "  ✗ $($_.Line.Trim())" -ForegroundColor Red
              } else {
                Write-Host "  ? $($_.Line.Trim())" -ForegroundColor Gray
              }
            }
          }
          
          # Check for skipped projects
          $skippedProjects = Select-String -Path $buildLog -Pattern "Skipping|skipping|will not be built" -CaseSensitive:$false
          if ($skippedProjects) {
            Write-Host "`nWARNING: Some projects were skipped:" -ForegroundColor Yellow
            $skippedProjects | Select-Object -First 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Yellow
            }
          }
          
          # Check if NNOGameServer project was built
          $gameServerBuild = Select-String -Path $buildLog -Pattern "NNOGameServer.*Build|Building.*NNOGameServer" -CaseSensitive:$false
          if ($gameServerBuild) {
            Write-Host "`nNNOGameServer build status:" -ForegroundColor Cyan
            $gameServerBuild | Select-Object -Last 5 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor $(if ($_.Line -match "succeeded") { "Green" } else { "Yellow" })
            }
          }
          
          # Show last 30 lines of log for context
          Write-Host "`n=== Last 30 lines of build log ===" -ForegroundColor Cyan
          Get-Content $buildLog -Tail 30 | ForEach-Object {
            if ($_ -match "error|ERROR|failed|FAILED") {
              Write-Host $_ -ForegroundColor Red
            } elseif ($_ -match "warning|WARNING") {
              Write-Host $_ -ForegroundColor Yellow
            } elseif ($_ -match "succeeded|SUCCEEDED|success") {
              Write-Host $_ -ForegroundColor Green
            } else {
              Write-Host $_ -ForegroundColor Gray
            }
          }
          
          Write-Host ""
          $errorCount = 0
          
          # Count errors - check for various error patterns
          $errorPatterns = @(
            "error\s+(CS|C\d{4}|LNK|MSB)",
            "error MSB",
            "error C",
            "error LNK",
            "fatal error",
            "cannot open",
            "unresolved external",
            "not found"
          )
          
          $allErrors = @()
          foreach ($pattern in $errorPatterns) {
            $matches = Select-String -Path $buildLog -Pattern $pattern -CaseSensitive:$false
            if ($matches) {
              $allErrors += $matches
            }
          }
          
          if ($allErrors) {
            $errorCount = ($allErrors | Select-Object -Unique Line).Count
            Write-Host "ERROR: Found $errorCount unique error(s)" -ForegroundColor Red
            Write-Host "`nFirst 20 errors:" -ForegroundColor Yellow
            $allErrors | Select-Object -First 20 -Unique Line | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Red
            }
          } else {
            Write-Host "OK: No compilation errors found in log" -ForegroundColor Green
          }
          
          # Check if build actually compiled anything
          Write-Host "`n=== Build Activity Analysis ===" -ForegroundColor Cyan
          
          # Check for compilation
          $compiling = Select-String -Path $buildLog -Pattern "Compiling|cl\.exe|\.c.*->.*\.obj|\.cpp.*->.*\.obj" -CaseSensitive:$false
          if ($compiling) {
            Write-Host "OK: Found compilation activity ($($compiling.Count) instances)" -ForegroundColor Green
            $compiling | Select-Object -First 5 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Gray
            }
          } else {
            Write-Host "CRITICAL: No compilation activity found!" -ForegroundColor Red
            Write-Host "  This means MSBuild skipped all compilation tasks." -ForegroundColor Red
            Write-Host "  Build 'succeeded' but no source files were compiled." -ForegroundColor Red
          }
          
          # Check for linking
          $linking = Select-String -Path $buildLog -Pattern "Linking|link\.exe|\.exe.*created|\.dll.*created|Creating library" -CaseSensitive:$false
          if ($linking) {
            Write-Host "OK: Found linking activity ($($linking.Count) instances)" -ForegroundColor Green
            $linking | Select-Object -First 5 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Gray
            }
          } else {
            Write-Host "CRITICAL: No linking activity found!" -ForegroundColor Red
            Write-Host "  This means no executable or library was created." -ForegroundColor Red
          }
          
          # Check for skipped tasks
          $skipped = Select-String -Path $buildLog -Pattern "skipped|Skipping|will be ignored" -CaseSensitive:$false
          if ($skipped) {
            Write-Host "`nWARNING: Found skipped tasks:" -ForegroundColor Yellow
            $skipped | Select-Object -First 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Yellow
            }
          }
          
          # Check for target completion
          $targets = Select-String -Path $buildLog -Pattern "Done building target|Done executing task|Build succeeded|Build FAILED|Build completed" -CaseSensitive:$false
          if ($targets) {
            Write-Host "`nBuild target status:" -ForegroundColor Cyan
            $targets | Select-Object -Last 15 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Gray
            }
          }
          
          # Check for project references that failed
          $refErrors = Select-String -Path $buildLog -Pattern "Project.*not found|unable to find|cannot open project|MSB3202|The project file.*was not found" -CaseSensitive:$false
          if ($refErrors) {
            Write-Host "`nCRITICAL: Project reference errors found:" -ForegroundColor Red
            Write-Host "  These errors cause MSBuild to skip compilation!" -ForegroundColor Red
            $refErrors | Select-Object -First 15 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Red
            }
          }
          
          # Check for pre-build event errors
          $prebuildErrors = Select-String -Path $buildLog -Pattern "pre-build|PreBuildEvent|exited with code|Error executing" -CaseSensitive:$false
          if ($prebuildErrors) {
            Write-Host "`nWARNING: Pre-build event issues found:" -ForegroundColor Yellow
            $prebuildErrors | Select-Object -First 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Yellow
            }
          }
          
          # Check for include file errors
          $includeErrors = Select-String -Path $buildLog -Pattern "cannot open include file|fatal error.*\.h|C1083" -CaseSensitive:$false
          if ($includeErrors) {
            Write-Host "`nERROR: Include file errors found:" -ForegroundColor Red
            $includeErrors | Select-Object -First 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Red
            }
          }
          
          # Check for PropertySheets errors
          $propsErrors = Select-String -Path $buildLog -Pattern "PropertySheets.*not found|MSB4019|The imported project.*was not found" -CaseSensitive:$false
          if ($propsErrors) {
            Write-Host "`nERROR: PropertySheets errors found:" -ForegroundColor Red
            $propsErrors | Select-Object -First 10 | ForEach-Object {
              Write-Host "  $($_.Line.Trim())" -ForegroundColor Red
            }
          }
          
          # Summary
          if (-not $compiling -and -not $linking) {
            Write-Host "`n❌ CRITICAL: Build failed in preparation phase!" -ForegroundColor Red
            Write-Host "  No compilation or linking activity detected." -ForegroundColor Red
            Write-Host "  MSBuild skipped all tasks due to:" -ForegroundColor Yellow
            if ($refErrors) {
              Write-Host "    ✅ Missing project references (most likely)" -ForegroundColor Red
            }
            if ($propsErrors) {
              Write-Host "    ✅ PropertySheets errors" -ForegroundColor Red
            }
            if ($prebuildErrors) {
              Write-Host "    ✅ Pre-build event failures" -ForegroundColor Red
            }
            if (-not $refErrors -and -not $propsErrors -and -not $prebuildErrors) {
              Write-Host "    ✅ Unknown reason - check build log for details" -ForegroundColor Yellow
            }
            Write-Host "`n  This is a 'silent failure' - build exits with code 0 but produces nothing." -ForegroundColor Yellow
          } elseif ($compiling -and -not $linking) {
            Write-Host "`n⚠️ WARNING: Files were compiled but not linked!" -ForegroundColor Yellow
            Write-Host "  This suggests linking step failed or was skipped." -ForegroundColor Yellow
          } elseif ($compiling -and $linking) {
            Write-Host "`n✅ OK: Build shows both compilation and linking activity" -ForegroundColor Green
          }
        } else {
          Write-Host "WARNING: Build log file not found" -ForegroundColor Yellow
          Write-Host "  Build may have failed before logging started." -ForegroundColor Yellow
        }
        
        # Also check build output for key indicators
        if ($buildOutput) {
          Write-Host "`n=== Build Output Summary ===" -ForegroundColor Cyan
          $outputLines = $buildOutput -split "`n"
          $successIndicators = $outputLines | Where-Object { $_ -match "succeeded|Build succeeded|0 Error" }
          $failureIndicators = $outputLines | Where-Object { $_ -match "failed|Build FAILED|Error\(s\)" }
          
          if ($successIndicators) {
            Write-Host "Build output shows success indicators:" -ForegroundColor Green
            $successIndicators | Select-Object -First 3 | ForEach-Object {
              Write-Host "  $_" -ForegroundColor Gray
            }
          }
          
          if ($failureIndicators) {
            Write-Host "Build output shows failure indicators:" -ForegroundColor Red
            $failureIndicators | Select-Object -First 3 | ForEach-Object {
              Write-Host "  $_" -ForegroundColor Red
            }
          }
        }
        
        # Check for output files - search more thoroughly
        Write-Host "`n=== Checking for Build Outputs ===" -ForegroundColor Cyan
        
        # First, try to find GameServer.exe specifically (the target name)
        $targetExe = "GameServer.exe"
        Write-Host "Looking for target executable: $targetExe" -ForegroundColor Cyan
        
        # Common output locations for Visual Studio projects
        # MSBuild typically outputs to: $(SolutionDir)$(Platform)\$(Configuration)\
        $searchPaths = @(
          "Debug\$targetExe",
          "Debug\Win32\$targetExe",
          "Win32\Debug\$targetExe",
          "$env:BUILD_PLATFORM\$env:BUILD_CONFIGURATION\$targetExe",
          "$env:BUILD_CONFIGURATION\$targetExe",
          "Release\$targetExe",
          "Release\Win32\$targetExe",
          "Win32\Release\$targetExe",
          "bin\Debug\$targetExe",
          "bin\Release\$targetExe",
          "bin\$env:BUILD_PLATFORM\$env:BUILD_CONFIGURATION\$targetExe",
          "$targetExe",
          ".\$targetExe"
        )
        
        # Also search directories
        $searchDirs = @(
          "Debug",
          "Release",
          "bin",
          "bin\Debug",
          "bin\Release",
          "x64\Debug",
          "x64\Release",
          "Win32\Debug",
          "Win32\Release",
          ".\Debug",
          ".\Release"
        )
        
        Write-Host "Searching for output files in:" -ForegroundColor Gray
        $searchPaths | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }
        $searchDirs | ForEach-Object { Write-Host "  - $_\" -ForegroundColor Gray }
        Write-Host ""
        
        $foundOutputs = $false
        $allFoundFiles = @()
        
        # First, check specific paths for the target exe
        foreach ($searchPath in $searchPaths) {
          if (Test-Path $searchPath) {
            $item = Get-Item $searchPath
            Write-Host "OK: Found target executable at: $searchPath" -ForegroundColor Green
            Write-Host "  Size: $([math]::Round($item.Length/1KB,2)) KB" -ForegroundColor Gray
            $allFoundFiles += $item
            $foundOutputs = $true
            break
          }
        }
        
        # If not found, search directories
        if (-not $foundOutputs) {
          foreach ($searchDir in $searchDirs) {
            if (Test-Path $searchDir) {
              $item = Get-Item $searchDir
              if ($item -is [System.IO.DirectoryInfo]) {
                $files = Get-ChildItem $searchDir -Recurse -File -ErrorAction SilentlyContinue
                if ($files) {
                  Write-Host "OK: Found output directory: $searchDir ($($files.Count) files)" -ForegroundColor Green
                  $exeFiles = $files | Where-Object { $_.Extension -eq '.exe' -or $_.Extension -eq '.dll' -or $_.Extension -eq '.lib' }
                  if ($exeFiles) {
                    Write-Host "  Executable/Library files:" -ForegroundColor Cyan
                    $exeFiles | Select-Object -First 10 Name, @{Name="Size(KB)";Expression={[math]::Round($_.Length/1KB,2)}}, FullName | Format-Table -AutoSize
                    $allFoundFiles += $exeFiles
                    $foundOutputs = $true
                  }
                }
              }
            }
          }
        }
        
        # Also search for .exe files recursively in current directory
        if (-not $foundOutputs) {
          Write-Host "Searching for .exe files recursively in current directory..." -ForegroundColor Yellow
          $exeFiles = Get-ChildItem "." -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "*GameServer*" -or $_.Name -like "*Game*" }
          if ($exeFiles) {
            Write-Host "OK: Found .exe files:" -ForegroundColor Green
            $exeFiles | Select-Object FullName, @{Name="Size(KB)";Expression={[math]::Round($_.Length/1KB,2)}} | Format-Table -AutoSize
            $foundOutputs = $true
            $allFoundFiles += $exeFiles
          }
        }
        
        # Search in solution-level output directories (common for solution builds)
        if (-not $foundOutputs) {
          Write-Host "Searching in solution-level output directories..." -ForegroundColor Yellow
          $solutionOutputDirs = @(
            "$env:BUILD_PLATFORM\$env:BUILD_CONFIGURATION",
            "$env:BUILD_CONFIGURATION\$env:BUILD_PLATFORM",
            ".\$env:BUILD_PLATFORM\$env:BUILD_CONFIGURATION"
          )
          foreach ($dir in $solutionOutputDirs) {
            if (Test-Path $dir) {
              Write-Host "Checking: $dir" -ForegroundColor Gray
              $exeFiles = Get-ChildItem $dir -Filter "*.exe" -ErrorAction SilentlyContinue
              if ($exeFiles) {
                Write-Host "OK: Found .exe files in $dir:" -ForegroundColor Green
                $exeFiles | Select-Object FullName, @{Name="Size(KB)";Expression={[math]::Round($_.Length/1KB,2)}} | Format-Table -AutoSize
                $foundOutputs = $true
                $allFoundFiles += $exeFiles
              }
            }
          }
        }
        
        # Show all directories in current location for debugging
        if (-not $foundOutputs) {
          Write-Host "`nCurrent directory structure:" -ForegroundColor Yellow
          Get-ChildItem "." -Directory | Select-Object Name | Format-Table -AutoSize
          Write-Host "All files in current directory:" -ForegroundColor Yellow
          Get-ChildItem "." -File | Select-Object Name, Length | Format-Table -AutoSize
        }
        
        if (-not $foundOutputs) {
          Write-Host "ERROR: No build output files found!" -ForegroundColor Red
          Write-Host "This indicates the build did not produce any executables." -ForegroundColor Yellow
        } else {
          Write-Host "`nOK: Total output files found: $($allFoundFiles.Count)" -ForegroundColor Green
        }
        
        echo "exit_code=$buildExitCode" >> $env:GITHUB_OUTPUT
        echo "found_outputs=$foundOutputs" >> $env:GITHUB_OUTPUT
        echo "error_count=$errorCount" >> $env:GITHUB_OUTPUT
        
        # Exit with error if build failed
        if ($buildExitCode -ne 0) {
          Write-Host "`nERROR: Build failed with exit code: $buildExitCode" -ForegroundColor Red
          exit $buildExitCode
        }
        
        if (-not $foundOutputs) {
          Write-Host "`nERROR: Build completed but no output files found!" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Upload build artifacts
      if: steps.build.outputs.found_outputs == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-outputs
        path: |
          GameServer.exe
          Debug/
          Debug/GameServer.exe
          Debug/Win32/
          Win32/Debug/
          Win32/Debug/GameServer.exe
          Release/
          Release/GameServer.exe
          bin/
          bin/Debug/
          bin/Release/
        if-no-files-found: warn
      
    - name: Show why no artifacts
      if: steps.build.outputs.found_outputs != 'true'
      run: |
        Write-Host "=== Why No Build Artifacts ===" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "Build completed but no output files were found." -ForegroundColor Red
        Write-Host ""
        Write-Host "This usually means:" -ForegroundColor Cyan
        Write-Host "  1. Missing dependencies (CrossRoads, Core, libs)" -ForegroundColor Gray
        Write-Host "  2. Build failed before compilation started" -ForegroundColor Gray
        Write-Host "  3. No source files were compiled" -ForegroundColor Gray
        Write-Host ""
        Write-Host "Check the build.log artifact for detailed error information." -ForegroundColor Yellow
        Write-Host "Download build-log to see what went wrong." -ForegroundColor Yellow
      shell: pwsh
        
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        if-no-files-found: ignore
        retention-days: 30
        
    - name: Build summary
      if: always()
      run: |
        Write-Host "`n=== Build Summary ===" -ForegroundColor Cyan
        
        $exitCode = "${{ steps.build.outputs.exit_code }}"
        $foundOutputs = "${{ steps.build.outputs.found_outputs }}"
        $errorCount = "${{ steps.build.outputs.error_count }}"
        
        Write-Host "Exit Code: $exitCode" -ForegroundColor $(if ($exitCode -eq "0") { "Green" } else { "Red" })
        Write-Host "Outputs Found: $foundOutputs" -ForegroundColor $(if ($foundOutputs -eq "true") { "Green" } else { "Red" })
        Write-Host "Error Count: $errorCount" -ForegroundColor $(if ($errorCount -eq "0") { "Green" } else { "Red" })
        
        if ($exitCode -eq "0" -and $foundOutputs -eq "true") {
          Write-Host "`nOK: Build completed successfully!" -ForegroundColor Green
          Write-Host "Check artifacts for build outputs." -ForegroundColor Gray
        } else {
          Write-Host "`nERROR: Build failed or no outputs generated" -ForegroundColor Red
          Write-Host "`nCommon reasons:" -ForegroundColor Yellow
          Write-Host "  1. Missing dependencies (CrossRoads, Core, libs)" -ForegroundColor Gray
          Write-Host "  2. Missing PropertySheets configuration files" -ForegroundColor Gray
          Write-Host "  3. Missing structparser.exe pre-build tool" -ForegroundColor Gray
          Write-Host "  4. Missing required header files or libraries" -ForegroundColor Gray
          Write-Host "  5. Compilation errors in source code" -ForegroundColor Gray
          Write-Host "`nCheck build.log artifact for detailed error information." -ForegroundColor Cyan
        }
      shell: pwsh

