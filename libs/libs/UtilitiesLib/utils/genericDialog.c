#if !PLATFORM_CONSOLE

#include "genericDialog.h"
#include "winutil.h"
#include "UTF8.h"

// Windows dialog boxes need a \r\n pair instead of just a \n in order
// to display things right.
void fixBackslashNs(char *buf, size_t buf_size)
{
	char *s;
	for (s=buf; *s; s++) {
		if (*s == '\n' && (s == buf || s[-1] != '\r')) {
			memmove_s(s+1, buf_size - (s+1 - buf), s, buf_size - (s + 1 - buf) - 1);
			*s = '\r';
		}
	}
}


//////////////////////////////////////////////////////////////////////
// these ugly looking things are the resources for the dialog boxes
// in hex.  because of the way the utilities lib is set up, resource
// files cannot be included.
//////////////////////////////////////////////////////////////////////
char OkToAllDialogResource[] =
{
	0x01, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc8, 0x00, 0xc0, 0x80, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf5, 0x00, 0x5a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x00, 
	0x69, 0x00, 0x61, 0x00, 0x6c, 0x00, 0x6f, 0x00, 0x67, 0x00, 0x00, 0x00, 0x08, 0x00, 0x90, 0x01, 
	0x00, 0x01, 0x4d, 0x00, 0x53, 0x00, 0x20, 0x00, 0x53, 0x00, 0x68, 0x00, 0x65, 0x00, 0x6c, 0x00, 
	0x6c, 0x00, 0x20, 0x00, 0x44, 0x00, 0x6c, 0x00, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x50, 0x3a, 0x00, 0x45, 0x00, 0x32, 0x00, 0x0e, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0xff, 0xff, 0x80, 0x00, 0x4f, 0x00, 0x4b, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x50, 0x8b, 0x00, 0x45, 0x00, 
	0x32, 0x00, 0x0e, 0x00, 0x05, 0x04, 0x00, 0x00, 0xff, 0xff, 0x80, 0x00, 0x4f, 0x00, 0x4b, 0x00, 
	0x20, 0x00, 0x74, 0x00, 0x6f, 0x00, 0x20, 0x00, 0x41, 0x00, 0x6c, 0x00, 0x6c, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x08, 0x01, 0x50, 
	0x07, 0x00, 0x07, 0x00, 0xe7, 0x00, 0x37, 0x00, 0x06, 0x04, 0x00, 0x00, 0xff, 0xff, 0x81, 0x00, 
	0x00, 0x00, 0x00, 0x00
};

char OkToAllCancelDialogResource[] = 
{
	0x01, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC8, 0x00, 0xC0, 0x80, 
    0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x00, 0x5A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x00, 
    0x69, 0x00, 0x61, 0x00, 0x6C, 0x00, 0x6F, 0x00, 0x67, 0x00, 0x00, 0x00, 0x08, 0x00, 0x90, 0x01, 
    0x00, 0x01, 0x4D, 0x00, 0x53, 0x00, 0x20, 0x00, 0x53, 0x00, 0x68, 0x00, 0x65, 0x00, 0x6C, 0x00, 
    0x6C, 0x00, 0x20, 0x00, 0x44, 0x00, 0x6C, 0x00, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x50, 0x57, 0x00, 0x45, 0x00, 0x32, 0x00, 0x0E, 0x00, 
    0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0x4F, 0x00, 0x4B, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x50, 0x14, 0x00, 0x45, 0x00, 
    0x32, 0x00, 0x0E, 0x00, 0x05, 0x04, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0x4F, 0x00, 0x4B, 0x00, 
    0x20, 0x00, 0x74, 0x00, 0x6F, 0x00, 0x20, 0x00, 0x41, 0x00, 0x6C, 0x00, 0x6C, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x08, 0x01, 0x50, 
    0x07, 0x00, 0x07, 0x00, 0xE7, 0x00, 0x37, 0x00, 0x0B, 0x04, 0x00, 0x00, 0xFF, 0xFF, 0x81, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x50, 
    0x95, 0x00, 0x45, 0x00, 0x32, 0x00, 0x0E, 0x00, 0x02, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0x00, 
    0x43, 0x00, 0x61, 0x00, 0x6E, 0x00, 0x63, 0x00, 0x65, 0x00, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00
};

char RequestStringDialogResource[] =
{
	0x01, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc8, 0x00, 0xc8, 0x80, 
	0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd7, 0x00, 0x6f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x00, 
	0x69, 0x00, 0x61, 0x00, 0x6c, 0x00, 0x6f, 0x00, 0x67, 0x00, 0x00, 0x00, 0x08, 0x00, 0x90, 0x01, 
	0x00, 0x01, 0x4d, 0x00, 0x53, 0x00, 0x20, 0x00, 0x53, 0x00, 0x68, 0x00, 0x65, 0x00, 0x6c, 0x00, 
	0x6c, 0x00, 0x20, 0x00, 0x44, 0x00, 0x6c, 0x00, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x50, 0x5f, 0x00, 0x5a, 0x00, 0x32, 0x00, 0x0e, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0xff, 0xff, 0x80, 0x00, 0x4f, 0x00, 0x4b, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x50, 0x9e, 0x00, 0x5a, 0x00, 
	0x32, 0x00, 0x0e, 0x00, 0x02, 0x00, 0x00, 0x00, 0xff, 0xff, 0x80, 0x00, 0x43, 0x00, 0x61, 0x00, 
	0x6e, 0x00, 0x63, 0x00, 0x65, 0x00, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x80, 0x08, 0x81, 0x50, 0x07, 0x00, 0x07, 0x00, 0xc9, 0x00, 0x33, 0x00, 
	0x09, 0x04, 0x00, 0x00, 0xff, 0xff, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x81, 0x50, 0x07, 0x00, 0x41, 0x00, 0xc9, 0x00, 0x10, 0x00, 
	0x0a, 0x04, 0x00, 0x00, 0xff, 0xff, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00
};



void flashWindow( HWND hWnd )
{
	FLASHWINFO fw;
	fw.cbSize = sizeof(FLASHWINFO);
	fw.hwnd = hWnd;
	fw.uCount = 0;
	fw.dwTimeout = 0;
	fw.dwFlags = FLASHW_TRAY | FLASHW_TIMERNOFG;
	//counter = GetTickCount();
	//FlashWindow( hWnd, TRUE );
	FlashWindowEx( &fw );
}

///////////////////////////////////////////////////////////
// OK TO ALL WITH CANCEL MESSAGE BOX
///////////////////////////////////////////////////////////

static char g_OkToAllCancelString[1024];
static char g_OkToAllCancelCaption[512];
GenericDialogCallback g_OkToAllCancelCallback = NULL;

LRESULT CALLBACK DlgOkToAllCancelProc (HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam)
{
	switch (iMsg)
	{
	case WM_INITDIALOG:
		SetWindowText_UTF8( hDlg, g_OkToAllCancelCaption );
		SetWindowText_UTF8(GetDlgItem(hDlg, IDC_OKTOALLCANCEL_EDIT), g_OkToAllCancelString);
		// flash the window if it is not the focus
		flashWindow(hDlg);
		break;
	case WM_COMMAND:
		if ( LOWORD(wParam) == IDCANCEL )
		{
			EndDialog(hDlg, IDCANCEL);
			return TRUE;
		}
		if ( LOWORD(wParam) == IDOK )
		{
			EndDialog(hDlg, IDOK);
			return TRUE;
		}
		if ( LOWORD(wParam) == IDC_OKTOALL )
		{
			EndDialog(hDlg, IDC_OKTOALL);
			return TRUE;
		}
		break;
	}

	return g_OkToAllCancelCallback == NULL ? FALSE : g_OkToAllCancelCallback(hDlg, iMsg, wParam, lParam);
}

int okToAllCancelDialog(char *dialogText, char *caption )
{
	int ret;
	strcpy( g_OkToAllCancelString, dialogText );
	strcpy( g_OkToAllCancelCaption, caption );
	fixBackslashNs(SAFESTR(g_OkToAllCancelString));
	fixBackslashNs(SAFESTR(g_OkToAllCancelCaption));
	ret = DialogBoxIndirect(winGetHInstance(), (LPDLGTEMPLATE)OkToAllCancelDialogResource, NULL, (DLGPROC)DlgOkToAllCancelProc);
	return (IDC_OKTOALL == ret ) ? IDOKTOALL : ((IDOK == ret) ? IDOK : IDCANCEL) ;
	//return (IDC_OKTOALL == DialogBox(winGetHInstance(), (LPCTSTR) (IDD_MB_OKTOALL), NULL, (DLGPROC)DlgOkToAllProc) );
}
int okToAllCancelDialogEx(char *dialogText, char *caption, GenericDialogCallback callback_proc)
{
	int ret;
	g_OkToAllCancelCallback = callback_proc;
	ret = okToAllCancelDialog(dialogText, caption );
	g_OkToAllCancelCallback = NULL;
	return ret;
}

///////////////////////////////////////////////////////////
// END OK TO ALL WITH CANCEL MESSAGE BOX
///////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////
// OK TO ALL MESSAGE BOX
///////////////////////////////////////////////////////////

static char g_OkToAllString[1024];
static char g_OkToAllCaption[512];
GenericDialogCallback g_OkToAllCallback = NULL;

LRESULT CALLBACK DlgOkToAllProc (HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam)
{
	switch (iMsg)
	{
	case WM_INITDIALOG:
		SetWindowText_UTF8( hDlg, g_OkToAllCaption );
		SetWindowText_UTF8(GetDlgItem(hDlg, IDC_OKTOALL_EDIT), g_OkToAllString);
		// flash the window if it is not the focus
		flashWindow(hDlg);
		break;
	case WM_COMMAND:
		if ( LOWORD(wParam) == IDOK )
		{
			EndDialog(hDlg, IDOK);
			return TRUE;
		}
		if ( LOWORD(wParam) == IDC_OKTOALL )
		{
			EndDialog(hDlg, IDC_OKTOALL);
			return TRUE;
		}
		break;
	}

	return g_OkToAllCallback == NULL ? FALSE : g_OkToAllCallback(hDlg, iMsg, wParam, lParam);
	return FALSE;
}

int okToAllDialog(char *dialogText, char *caption)
{
	strcpy( g_OkToAllString, dialogText );
	strcpy( g_OkToAllCaption, caption );
	fixBackslashNs(SAFESTR(g_OkToAllString));
	fixBackslashNs(SAFESTR(g_OkToAllCaption));
	return (IDC_OKTOALL == DialogBoxIndirect(winGetHInstance(), (LPDLGTEMPLATE)OkToAllDialogResource, NULL, (DLGPROC)DlgOkToAllProc) ) ? IDOKTOALL : IDOK;
	//return (IDC_OKTOALL == DialogBox(winGetHInstance(), (LPCTSTR) (IDD_MB_OKTOALL), NULL, (DLGPROC)DlgOkToAllProc) );
}
int okToAllDialogEx(char *dialogText, char *caption, GenericDialogCallback callback_proc)
{
	int ret;
	g_OkToAllCallback = callback_proc;
	ret = okToAllDialog(dialogText, caption);
	g_OkToAllCallback = NULL;
	return ret;
}

///////////////////////////////////////////////////////////
// END OK TO ALL MESSAGE BOX
///////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////
// REQUEST STRING DIALOG
///////////////////////////////////////////////////////////

static char g_RequestStringText[1024];
static char g_RequestStringCaption[512];
static char *spRequestStringInput = NULL;
GenericDialogCallback g_RequestStringCallback = NULL;

LRESULT CALLBACK DlgRequestStringProc (HWND hDlg, UINT iMsg, WPARAM wParam, LPARAM lParam)
{
	switch (iMsg)
	{
	case WM_INITDIALOG:
		SetWindowText_UTF8( hDlg, g_RequestStringCaption );
		SetWindowText_UTF8(GetDlgItem(hDlg, IDC_EDIT_REQUEST_STRING), g_RequestStringText);
		// flash the window if it is not the focus
		flashWindow(hDlg);
		break;
	case WM_COMMAND:
		if ( LOWORD(wParam) == IDOK )
		{
			GetWindowText_UTF8(GetDlgItem(hDlg, IDC_EDIT_INPUT_STRING), &spRequestStringInput);
			EndDialog(hDlg, IDOK);
			return TRUE;
		}
		if ( LOWORD(wParam) == IDCANCEL )
		{
			EndDialog(hDlg, IDCANCEL);
			return TRUE;
		}
		break;
	case WM_DESTROY:
	case WM_CLOSE:
	case 0x00000046: // no clue what this message is, but its the one passed by EndDialog
		return TRUE;
		break;
	}

	if ( !g_RequestStringCallback )
		return FALSE;
	else
		return g_RequestStringCallback(hDlg, iMsg, wParam, lParam);
}

char *requestStringDialog(char *dialogText, char *caption )
{
	strcpy( g_RequestStringText, dialogText );
	strcpy( g_RequestStringCaption, caption );
	fixBackslashNs(SAFESTR(g_RequestStringText));
	fixBackslashNs(SAFESTR(g_RequestStringCaption));
	return (IDOK == DialogBoxIndirect(winGetHInstance(), (LPDLGTEMPLATE)RequestStringDialogResource, NULL, 
		(DLGPROC)DlgRequestStringProc) ) ? spRequestStringInput : NULL;
	//return (IDOK == DialogBox(winGetHInstance(), (LPCTSTR) (IDD_DLG_REQUEST_STRING), NULL, (DLGPROC)DlgRequestStringProc)) ? g_RequestStringInput : NULL;
}

char *requestStringDialogEx(char *dialogText, char *caption, GenericDialogCallback callback_proc)
{
	char *ret;
	g_RequestStringCallback = callback_proc;
	ret = requestStringDialog(dialogText, caption);
	g_RequestStringCallback = NULL;
	return ret;
}

///////////////////////////////////////////////////////////
// END REQUEST STRING DIALOG
///////////////////////////////////////////////////////////

#endif