/***************************************************************************
*     Copyright (c) 2005-2011, Cryptic Studios
*     All Rights Reserved
*     Confidential Property of Cryptic Studios
***************************************************************************/

#pragma once

#include "GlobalTypeEnum.h"
#include "referencesystem.h"
#include "StashTable.h"
#include "LobbyCommon.h"

typedef enum TeamMode TeamMode;
typedef enum LootMode LootMode;
typedef enum ItemQuality ItemQuality;
typedef struct CharacterClass CharacterClass;
typedef struct CharacterPath CharacterPath;
typedef struct GameProgressionNodeDef GameProgressionNodeDef;
typedef struct GameContentNodeRef GameContentNodeRef;
typedef struct PlayerCostume PlayerCostume;
typedef struct SpeciesDef SpeciesDef;
typedef struct UGCProject UGCProject;
typedef struct GameContentNodeRef GameContentNodeRef;
typedef struct AdditionalCharacterPath AdditionalCharacterPath;

#define GAME_SESSION_MIN_COUNT_PER_GROUP 5
#define GAME_SESSION_MAX_COUNT_PER_GROUP 100

AUTO_STRUCT;
typedef struct GameSessionJoinRequest
{
	// Container ID of the player who is requesting to join the session
	ContainerID iEntID;

	// The name of the player
	const char *pchName;

	// The account handle of the player
	const char *pchAccountHandle;
} GameSessionJoinRequest;

AUTO_STRUCT;
typedef struct GameSessionParticipant
{
	// The participant's container ID
	ContainerID iEntID;

	// The name of the player
	const char *pchName;

	// The public account name of the player
	char *pchAccountName;

	// Indicates if this member is the party leader
	bool bLeader;

	// The map name
	const char *pchMapName;

	// Message key for the map display name
	const char *pchMapMsgKey;

	// Map vars
	const char *pchMapVars;

	// Map instance number
	U32 uiMapInstanceNumber;

	// Map container ID
	U32 iMapContainerID;

	// Partition ID
	U32 iPartitionID;

	// Ready flag. This is just a hint to the leader.
	bool bReady;

	// Character class
	REF_TO(CharacterClass) hClass;		AST(REFDICT(CharacterClass))

	// Character path
	REF_TO(CharacterPath) hPath;		AST(REFDICT(CharacterPath))

	EARRAY_OF(AdditionalCharacterPath) ppSecondaryPaths;

	// Species
	REF_TO(SpeciesDef) hSpecies;		AST(REFDICT(Species))

	// XP Level
	S32 iExpLevel;

	// Costume in the first slot of the player.
	PlayerCostume *pCostume;

	// Completed progression nodes for this participant. The list is sorted.
	const char **ppchCompletedNodes;		AST(POOL_STRING)

} GameSessionParticipant;

AUTO_STRUCT;
typedef struct GameSession
{
	// The container ID for the team which participates in the game session
	ContainerID iTeamID;								AST( KEY )

	// Team mode which determines the joining rules
	TeamMode eTeamMode;

	// Loot mode for the game session
	LootMode eLootMode;

	// Item quality threshold
	const char* eLootModeItemQuality;					AST(POOL_STRING)

	// Status message
	char * pchStatusMessage;							AST(ESTRING)

	// The list of participants
	GameSessionParticipant **eaParticipants;

	// The list of requests
	GameSessionJoinRequest **eaRequests;

	// The destination, either a game progression node or a UGC project
	GameContentNodeRef destination;

	// Time this session is marked for deletion
	U32 uiDeletionTimestamp;

	// Indicates whether this session is in the lobby
	U32 bInLobby : 1;

	// The data version of the game session. Any time the data changes, the version is incremented
	U32 iVersion;
} GameSession;

AUTO_STRUCT;
typedef struct GameSessionGroupInfo
{
	// The key identifying the game session group. 
	// This is either the name of the game progression node or a key generated by UGC
	char *pchName;			AST( KEY NO_NETSEND )

	// The node ref which indicates whether this group is a game progression node or UGC
	GameContentNodeRef nodeRef;

	// Sorted list of game sessions which belong to this group. The list actually contains the
	// team IDs which provides us immediate access via the global list.
	S32 *piSessions;		AST( NO_NETSEND )

	// The number of game sessions in this group. The field is only filled before this struct
	// is sent over network. Do not rely on this field in the server
	S32 iSessionCount;

	// Version number. Increment anytime the list of game sessions change.
	U32 iVersion;			AST( NO_NETSEND )
} GameSessionGroupInfo;

AUTO_STRUCT;
typedef struct GameSessionQuery
{
	// Group name
	char *pchGroupName;

	// Version number
	U32 iVersion;

	// The number of records requested
	S32 iNumRecords;

	// The list of friend team IDs
	U32 *piTeamIDs;

	// Only include teams with friends?
	bool bFriendsOnly;

} GameSessionQuery;

AUTO_STRUCT;
typedef struct GameSessionQueryResult
{
	// Destination for all sessions
	GameContentNodeRef nodeRef;

	// Version number for this list
	U32 iVersion;

	// The list of game sessions
	GameSession **ppGameSessions;

} GameSessionQueryResult;

AUTO_STRUCT;
typedef struct GameSessionCallbackData
{
	S32 iLoginCookieStored;
	ContainerID uiTeamID;
	ContainerID uiEntID;
	ContainerID uiNewEntID;
} GameSessionCallbackData;

// Returns a static string which will be shared by all calls to this function. This function never returns NULL.
const char* gameSession_GetDestinationName(SA_PARAM_NN_VALID GameSession *pGameSession);