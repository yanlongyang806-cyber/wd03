//// Interface for raising errors at specific scope/fields for UGC.
////
//// This is used to give tasks to authors to do.
#pragma once

AUTO_ENUM;
typedef enum UGCRuntimeErrorType
{
	UGC_WARNING,						// Something the user should probably know about but not a serious problem
	UGC_ERROR,							// A potentially serious problem with the generator algorithm
	UGC_FATAL_ERROR,					// We've hit an error that halts the generation process
} UGCRuntimeErrorType;
extern StaticDefineInt UGCRuntimeErrorTypeEnum[];

AUTO_ENUM;
typedef enum UGCRuntimeErrorScope
{
	UGC_SCOPE_DEFAULT,					// No knowledge, shouldn't be used
	UGC_SCOPE_MAP,						// This error has to do with global map properties
	UGC_SCOPE_ROOM,						// This error has to do with a specific room in the layout
	UGC_SCOPE_PATH,						// This error has to do with a specific path in the layout
	UGC_SCOPE_CHALLENGE,				// This error has to do with a specific challenge in the layout
	UGC_SCOPE_OBJECTIVE,				// This error has to do with a specific objective in the layout
	UGC_SCOPE_PROMPT,					// This error has to do with a specific prompt in the layout
	UGC_SCOPE_MISSION,					// This error has to do with a mission
	UGC_SCOPE_PORTAL,
	UGC_SCOPE_ROOM_DOOR,
	UGC_SCOPE_LAYOUT,
	UGC_SCOPE_EPISODE_PART,
	UGC_SCOPE_SOLSYS_DETAIL_OBJECT,
	UGC_SCOPE_MAP_TRANSITION,
	UGC_SCOPE_UGC_ITEM,
	
	UGC_SCOPE_INTERNAL_DICT,			// This error has to do with an internal dictionary
	UGC_SCOPE_INTERNAL_CODE,
} UGCRuntimeErrorScope;

AUTO_STRUCT;
typedef struct UGCRuntimeErrorContext
{
	UGCRuntimeErrorScope scope;			AST(NAME("Scope"))
	bool auto_generated;					AST(NAME("AutoGenerated"))

	char* map_name;							AST(NAME("MapName"))
	char* location_name;					AST(NAME("LocationName", "RoomName", "PathName"))
	char* challenge_name;					AST(NAME("ChallengeName"))
	char* objective_name;					AST(NAME("ObjectiveName"))
	char* prompt_name;						AST(NAME("PromptName"))
	char* prompt_block_name;				AST(NAME("PromptBlockName")) 
	int prompt_action_index;				AST(NAME("PromptActionIndex") DEFAULT(-1))
	char* mission_name;						AST(NAME("MissionName"))
	char* portal_name;						AST(NAME("PortalName"))
	char* layout_name;						AST(NAME("LayoutName"))
	char* solsys_detail_object_name;		AST(NAME("SolSysDetailObjectName"))
	char* ep_part_name;						AST(NAME("EpPartName", "EpisodePartName"))
	char* ugc_item_name;					AST(NAME("UGCItemName"))
	
	const char* dict_name;					AST(NAME("DictionaryName") POOL_STRING)
	const char* resource_name;				AST(NAME("ResourceName") POOL_STRING)
} UGCRuntimeErrorContext;
extern ParseTable parse_UGCRuntimeErrorContext[];
#define TYPE_parse_UGCRuntimeErrorContext UGCRuntimeErrorContext

AUTO_STRUCT;
typedef struct UGCRuntimeError
{
	UGCRuntimeErrorType type;			AST(NAME("Type"))
	UGCRuntimeErrorContext* context;	AST(NAME("Entry"))
	char *field_name;						AST(NAME("FieldName"))
	char *object_name;						AST(NAME("ObjectName")) // Name of the scope object, if there is one (i.e. room or challenge name)
	char *message;							AST(NAME("Message"))
	const char *message_key;				AST(NAME("MessageKey") POOL_STRING)

	// Use sparingly!  This text is not translated!
	char* extraText;						AST(NAME("ExtraText"))
} UGCRuntimeError;
extern ParseTable parse_UGCRuntimeError[];
#define TYPE_parse_UGCRuntimeError UGCRuntimeError

AUTO_STRUCT;
typedef struct UGCRuntimeStage
{
	char *name;								AST(STRUCTPARAM)
	UGCRuntimeError **errors;			AST(NAME("Error"))
} UGCRuntimeStage;
extern ParseTable parse_UGCRuntimeStage[];
#define TYPE_parse_UGCRuntimeStage UGCRuntimeStage

AUTO_STRUCT;
typedef struct UGCRuntimeStatus
{
	UGCRuntimeStage **stages;			AST(NAME("Stage")) // Each stage of the process creates a new block here
} UGCRuntimeStatus;
extern ParseTable parse_UGCRuntimeStatus[];
#define TYPE_parse_UGCRuntimeStatus UGCRuntimeStatus

void ugcRaiseErrorContext(UGCRuntimeErrorType type, UGCRuntimeErrorContext* context, char* message, ...);
void ugcRaiseErrorInternal(UGCRuntimeErrorType type, const char* dict_name, const char *object_name, char *message, ...);
void ugcRaiseErrorInternalCode(UGCRuntimeErrorType type, char *message, ...);
void ugcRaiseError(UGCRuntimeErrorType type, UGCRuntimeErrorContext* context, const char *message_key, char* message, ...);
void ugcRaiseErrorInField(UGCRuntimeErrorType type, UGCRuntimeErrorContext* context, const char* fieldName, const char *message_key, char* message, ...);
void ugcRaiseErrorInFieldExtraText(UGCRuntimeErrorType type, UGCRuntimeErrorContext* context, const char* fieldName, const char *message_key, const char* extra_text, char* message, ...);

// Internal only. Use the macros below.
UGCRuntimeErrorContext* ugcMakeErrorContextDefault_Internal(bool alloc MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextMap_Internal(bool alloc, const char *map_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextRoom_Internal(bool alloc, const char *room_name, const char *layout_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextRoomDoor_Internal(bool alloc, const char *challenge_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextPath_Internal(bool alloc, const char *path_name, const char *layout_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextChallenge_Internal(bool alloc, const char *challenge_name, const char *mission_name, const char *layout_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextObjective_Internal(bool alloc, const char *objective_name, const char *mission_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextPrompt_Internal(bool alloc, const char *prompt_name, const char *block_name, const char *mission_name, const char *layout_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextLockedDoor_Internal(bool alloc, const char *target_name, const char *mission_name, const char *layout_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextMission_Internal(bool alloc, const char *mission_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextPortal_Internal(bool alloc, const char *portal_name, const char *mission_name, const char *layout_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextLayout_Internal(bool alloc, const char *layout_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextEpisodePart_Internal(bool alloc, const char *episode_part MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextSolSysDetailObject_Internal(bool alloc, const char *detail_object_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextDictionary_Internal(bool alloc, const char *dict_name, const char *res_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextMapTransition_Internal(bool alloc, const char *objective_name, const char *mission_name MEM_DBG_PARMS);
UGCRuntimeErrorContext* ugcMakeErrorContextUGCItem_Internal(bool alloc, const char *item_name MEM_DBG_PARMS);

// These allocate a new UGCRuntimeErrorContext, which must be freed.
#define ugcMakeErrorContextDefault()								ugcMakeErrorContextDefault_Internal(true MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextMap(map_name)							ugcMakeErrorContextMap_Internal(true, map_name MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextRoom(room, layout)						ugcMakeErrorContextRoom_Internal(true, room, layout MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextRoomDoor(challenge)						ugcMakeErrorContextRoomDoor_Internal(true, challenge MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextPath(path, layout)						ugcMakeErrorContextPath_Internal(true, path, layout MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextChallenge(challenge, mission, layout)	ugcMakeErrorContextChallenge_Internal(true, challenge, mission, layout MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextObjective(objective, mission)			ugcMakeErrorContextObjective_Internal(true, objective, mission MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextPrompt(prompt, block, mission, layout)	ugcMakeErrorContextPrompt_Internal(true, prompt, block, mission, layout MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextMission(mission)							ugcMakeErrorContextMission_Internal(true, mission MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextPortal(portal, mission, layout)			ugcMakeErrorContextPortal_Internal(true, portal, mission, layout MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextLayout(layout)							ugcMakeErrorContextLayout_Internal(true, layout MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextLockedDoor(target, mission, layout)		ugcMakeErrorContextLockedDoor_Internal(true, target, mission, layout MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextEpisodePart(part)						ugcMakeErrorContextEpisodePart_Internal(true, part MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextSolSysDetailObject(object)				ugcMakeErrorContextSolSysDetailObject_Internal(true, object MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextDictionary(dictionary, resource)			ugcMakeErrorContextDictionary_Internal(true, dictionary, resource MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextMapTransition(objective, mission)		ugcMakeErrorContextMapTransition_Internal(true, objective, mission MEM_DBG_PARMS_INIT)
#define ugcMakeErrorContextUGCItem(item)							ugcMakeErrorContextUGCItem_Internal(true, item MEM_DBG_PARMS_INIT)

// These return a global variable, to be passed immediately to UGCRaiseError()
#define ugcMakeTempErrorContextDefault()								ugcMakeErrorContextDefault_Internal(false MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextMap(map_name)								ugcMakeErrorContextMap_Internal(false, map_name MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextRoom(room, layout)						ugcMakeErrorContextRoom_Internal(false, room, layout MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextRoomDoor(challenge)						ugcMakeErrorContextRoomDoor_Internal(false, challenge MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextPath(path, layout)						ugcMakeErrorContextPath_Internal(false, path, layout MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextChallenge(challenge, mission, layout)	ugcMakeErrorContextChallenge_Internal(false, challenge, mission, layout MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextObjective(objective, mission)			ugcMakeErrorContextObjective_Internal(false, objective, mission MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextPrompt(prompt, block, mission, layout)	ugcMakeErrorContextPrompt_Internal(false, prompt, block, mission, layout MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextMission(mission)							ugcMakeErrorContextMission_Internal(false, mission MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextPortal(portal, mission, layout)			ugcMakeErrorContextPortal_Internal(false, portal, mission, layout MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextLockedDoor(target, mission, layout)		ugcMakeErrorContextLockedDoor_Internal(false, target, mission, layout MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextLayout(layout)							ugcMakeErrorContextLayout_Internal(false, layout MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextEpisodePart(part)						ugcMakeErrorContextEpisodePart_Internal(false, part MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextSolSysDetailObject(object)				ugcMakeErrorContextSolSysDetailObject_Internal(false, object MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextDictionary(dictionary, resource)			ugcMakeErrorContextDictionary_Internal(false, dictionary, resource MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextMapTransition(objective, mission)		ugcMakeErrorContextMapTransition_Internal(false, objective, mission MEM_DBG_PARMS_INIT)
#define ugcMakeTempErrorContextUGCItem(item)							ugcMakeErrorContextUGCItem_Internal(false, item MEM_DBG_PARMS_INIT)

UGCRuntimeErrorContext* ugcMakeErrorAutoGen(UGCRuntimeErrorContext *context);

bool ugcStatusFailed(UGCRuntimeStatus *status);
bool ugcStatusHasErrors(UGCRuntimeStatus *status, UGCRuntimeErrorType errorLevel);
void ugcSetStageAndAdd(UGCRuntimeStatus *status, char* stageName, ...);
void ugcClearStage(void);

UGCRuntimeError* ugcStatusMostImportantError( UGCRuntimeStatus* status );
int ugcStatusErrorCount( const UGCRuntimeStatus* status );

void ugcStatusGetErrors( UGCRuntimeError*** out_peaErrors, UGCRuntimeStatus* status );
